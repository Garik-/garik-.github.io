<!DOCTYPE html><html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"><link rel="stylesheet" href="/stylesheets/style.css"><link rel="icon" href="/images/favicon.ico"><link rel="apple-touch-icon" href="/images/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><script src="/javascripts/counter.js"></script><title>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ÃÜ | by Igor Riakhovskii</title><meta name="description" content="–°—Ç–∞—Ç—å—è –Ω–µ –ø—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É, –≤ –Ω–µ–π –æ–ø–∏—Å–∞–Ω –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ C, node.js –∏ golang. –í –∫–∞–∂–¥–æ–º —è–∑—ã–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–∏..."><meta property="og:title" content="–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ÃÜ"><meta property="og:description" content="–°—Ç–∞—Ç—å—è –Ω–µ –ø—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É, –≤ –Ω–µ–π –æ–ø–∏—Å–∞–Ω –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ C, node.js –∏ golang. –í –∫–∞–∂–¥–æ–º —è–∑—ã–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–∏..."><meta property="og:type" content="article"><meta property="article:published_time" content="2021-11-04T21:00:00+03:00"><meta property="article:modified_time" content="2025-01-12T04:24:17+03:00"><meta property="profile:first_name" content="Igor"><meta property="profile:last_name" content="Riakhovskii"><meta property="profile:username" content="garikdjan"><meta property="article:tag" content="Architecture"><meta property="article:tag" content="Golang"></head><body><main class="article-layout"><div class="container"><article><h1 class="post-title">–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ÃÜ</h1><section class="post-info"><a class="author-photo-link" rel="noopener follow" href="/"><img class="author-photo" alt="Igor Riakhovskii" src="/v1/resize:fill:88:88/public/avatar.jpg" width="44" height="44" loading="lazy"><div class="author-photo-shadow"></div></a><div class="post-info-author"><a class="author-name" rel="noopener follow" href="/">Igor Riakhovskii</a><div class="post-info-date"><span>12 min read</span><span class="separator">¬∑</span><span>Nov 4, 2021</span></div></div></section><div class="post-content">
  <figure>
    <picture>
        <source srcset="/v1/resize:fit:640/format:webp/arch-muilti-apps.webp 640w, /v1/resize:fit:720/format:webp/arch-muilti-apps.webp 720w, /v1/resize:fit:750/format:webp/arch-muilti-apps.webp 750w, /v1/resize:fit:768/format:webp/arch-muilti-apps.webp 768w, /v1/resize:fit:828/format:webp/arch-muilti-apps.webp 828w, /v1/resize:fit:1100/format:webp/arch-muilti-apps.webp 1100w, /v1/resize:fit:1400/format:webp/arch-muilti-apps.webp 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp">
        <source srcset="/v1/resize:fit:640/arch-muilti-apps.webp 640w, /v1/resize:fit:720/arch-muilti-apps.webp 720w, /v1/resize:fit:750/arch-muilti-apps.webp 750w, /v1/resize:fit:768/arch-muilti-apps.webp 768w, /v1/resize:fit:828/arch-muilti-apps.webp 828w, /v1/resize:fit:1100/arch-muilti-apps.webp 1100w, /v1/resize:fit:1400/arch-muilti-apps.webp 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px">
        <img alt="" width="1400" height="800" loading="lazy" role="presentation" src="/v1/resize:fit:1400/arch-muilti-apps.webp">
    </picture>
    
  </figure>
  
<p>–°—Ç–∞—Ç—å—è –Ω–µ –ø—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É, –≤ –Ω–µ–π –æ–ø–∏—Å–∞–Ω –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ C, node.js –∏ golang. –í –∫–∞–∂–¥–æ–º —è–∑—ã–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —è–∑—ã–∫–∞—Ö –¥–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö, –Ω–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –≤–µ–∑–¥–µ –æ–¥–Ω–∞.</p>
<p>–°—Ç–∞—Ç—å—è –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–∞ —è–∑—ã–∫–æ–º go, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–æ–∫–∞–º–∏ –∏–∑ –∫–æ—Ä–æ–±–∫–∏.</p>
<h1>–î–ª—è –∫–æ–≥–æ —ç—Ç–æ</h1>
<p>–≠—Ç–æ —Å—Ç–∞—Ç—å—è –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–µ—Ç–µ–≤—ã–º (–±—ç–∫–µ–Ω–¥) —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º, –Ω–æ —Ö–æ—á–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–µ—Ä–≤–∏—Å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π API –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö (HTTP, WebSocket, etc. over TCP).</p>
<h1>–ü–∞—Ç—Ç–µ—Ä–Ω WaitGroup</h1>
<p>–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞, –≤–∞—à –∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ</p>
<pre><code>func thread() { while(true) print(1) } // child thread
create_thread(thread)
while(true) print(2) // main thread
</code></pre>
<pre><code>2
1
1
1
2
2
1
2
</code></pre>
<p>–∏ –∑–∞–≤–µ—Ä—à–∏–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —Å–∏—Å—Ç–µ–º–∞ —É–±–∏–≤–∞–µ—Ç (–∞ –º–æ–∂–µ—Ç –∏ –Ω–µ —Å—Ä–∞–∑—É) –¥–æ—á–µ—Ä–Ω–∏–µ –ø–æ—Ç–æ–∫–∏</p>
<pre><code>func work() { sleep(1m); print("child") } // child thread
create_thread(work)
print("main") // main thread
exit(0)
</code></pre>
<pre><code>main
</code></pre>
<p>—á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Ç–æ–∫–∞ work. –î–ª—è —ç—Ç–æ–≥–æ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö —è–∑—ã–∫–∞ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ <em>wait-—Ñ—É–Ω–∫—Ü–∏–∏</em> <code>wait_thread(work)</code>, –Ω–æ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∑–∞–¥–∞—á—É –ø–æ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ.</p>
<p>–ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å N –ø–æ—Ç–æ–∫–æ–≤ –∏ –∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –µ—â–µ X –ø–æ—Ç–æ–∫–æ–≤? –û—Ç–≤–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω <strong>wait group</strong>.</p>
<p>–ó–∞–≤–µ–¥–µ–º <strong>–∞—Ç–æ–º–∞—Ä–Ω—ã–π</strong> —Å—á–µ—Ç—á–∏–∫ –∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–∞ –±—É–¥–µ–º –µ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –Ω–∞ 1, –∞ –≤ —Å–∞–º–æ–º –ø–æ—Ç–æ–∫–µ –ø—Ä–∏ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —É–º–µ–Ω—å—à–∞—Ç—å –Ω–∞ 1</p>
<pre><code class="hljs language-go">atomic <span class="hljs-type">int</span> wait_group = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inc</span><span class="hljs-params">()</span></span> { wait_group = wait_group + <span class="hljs-number">1</span> }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dec</span><span class="hljs-params">()</span></span> { wait_group = wait_group - <span class="hljs-number">1</span> }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">work1</span><span class="hljs-params">()</span></span> {
  sleep(<span class="hljs-number">30</span>s) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"work1"</span>)
  dec()
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">work2</span><span class="hljs-params">()</span></span> {
  sleep(<span class="hljs-number">10</span>s)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"work2"</span>)
  dec()
}

inc()
create_thread(work1)
<span class="hljs-type">int</span>()
create_thread(work2)

wihle(wait_group != <span class="hljs-number">0</span>) {} <span class="hljs-comment">// wait in main thread</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"exit"</span>)
</code></pre>
<pre><code>work2
work1
exit
</code></pre>
<p>–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç.</p>
<p>–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –Ω—É–∂–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–∞, –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–¥ –ø—Ä–æ–∏–∑–≤–µ–¥–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç. –ü–æ–¥–æ–±–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –≥–æ–Ω–∫–∏ (race condition), –∏—Ö —Å—Ç–æ–∏—Ç –∏–∑–±–µ–≥–∞—Ç—å, –Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –¥–∞–ª—å—à–µ.</p>
<h2>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ WaitGroup</h2>
<p>–î–∞–≤–∞–π—Ç–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤—ã –≤–æ–∑—å–º–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é WaitGroup –∏–∑ —è–∑—ã–∫–∞ Go</p>
<pre><code class="hljs language-go">wg.add() <span class="hljs-comment">// –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞</span>
wg.done() <span class="hljs-comment">// –¥–µ–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞</span>
wg.wait() <span class="hljs-comment">// –æ–∂–∏–¥–∞–Ω–∏–µ –Ω—É–ª—è –≤ —Å—á–µ—Ç—á–∏–∫–µ</span>
</code></pre>
<p>–ú—ã —É–∂–µ –ø–æ–Ω—è–ª–∏, —á—Ç–æ –ø–æ—Ç–æ–∫ ‚Äî —ç—Ç–æ –∫–∞–∫–∞—è-—Ç–æ –¥–æ–ª–≥–∞—è —Ä–∞–±–æ—Ç–∞, –¥–∞–≤–∞–π—Ç–µ –≤—ã—Ä–∞–∑–∏–º –µ–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º</p>
<pre><code class="hljs language-go"><span class="hljs-keyword">interface</span> Worker {
  run(): void
}

<span class="hljs-keyword">type</span> Workers = Worker[]
</code></pre>
<p>–ò —Ç–µ–ø–µ—Ä—å –Ω–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// main</span>
Workers works = [<span class="hljs-built_in">new</span> Work1, <span class="hljs-built_in">new</span> Work2, <span class="hljs-built_in">new</span> Work3]
<span class="hljs-keyword">for</span> (work of works) {
  wg.add()
  create_thread(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">// create new thread</span>
    work.run()
    wg.done()
  })
}
wg.wait()
</code></pre>
<p>–¢–µ–ø–µ—Ä—å –≤—Å—è —Ä–∞–±–æ—Ç–∞ —Å –ø–æ—Ç–æ–∫–∞–º–∏ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –º—ã –º–æ–∂–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã –Ω–∞ –Ω–∞—à–∏ –∫–ª–∞—Å—Å—ã. –ù–æ —É –Ω–∞—Å –ø–æ—è–≤–∏–ª–∞—Å—å –¥—Ä—É–≥–∞—è –∑–∞–¥–∞—á–∞ - –º—ã –∑–∞—Ö–æ—Ç–µ–ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤—Å–µ –≤–æ—Ä–∫–µ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.</p>
<h1>–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤</h1>
<p>–ù–∏ –¥–ª—è –∫–æ–≥–æ –Ω–µ —Å–µ–∫—Ä–µ—Ç —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å 24/7. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞.</p>
<p>–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–æ—Ç–æ—Ä–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–∫–µ—Ç. –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã unix –æ—Ç–∫—Ä—ã—Ç—ã–π —Å–æ–∫–µ—Ç —ç—Ç–æ —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —è–¥—Ä–æ–º –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ï—Å–ª–∏ –º—ã –∑–∞–≤–µ—Ä—à–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–¥ —Å–µ—Ä–≤–µ—Ä–∞, –æ–Ω —É–±—å–µ—Ç –ø–æ—Ç–æ–∫–∏, –Ω–æ –≤ —è–¥—Ä–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —Å–æ–∫–µ—Ç–æ–≤ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ (–Ω–∞ –≤—Ä–µ–º—è tcp_keepalive_time + tcp_keepalive_probes * tcp_keepalive_intvl - –Ω–æ —ç—Ç–æ –Ω–µ —Ç–æ—á–Ω–æ üôÇ ) –∏ –≤—Å–∫–æ—Ä–µ –º—ã –Ω–µ —Å–º–æ–∂–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª–æ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –±—É–¥—É—Ç –∑–∞–Ω—è—Ç—ã. –ù–µ —Å—Ç–æ–∏—Ç —Ç–∞–∫–∂–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é –ø–∞–º—è—Ç–∏ –∏ —É–ø–æ–≤–∞—Ç—å –Ω–∞ garbage collector –≤–∞—à–µ–≥–æ —è–∑—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ù–µ–±–æ–ª—å—à–∞—è —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7 –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.</p>
<h2>–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤</h2>
<p>–°–æ–∑–¥–∞—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ <strong>–∞—Ç–æ–º–∞—Ä–Ω—ã–π</strong> —Ñ–ª–∞–≥ <code>done</code> –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ–≥–æ –≤ –¥–æ—á–µ—Ä–Ω–∏–µ –ø–æ—Ç–æ–∫–∏ –ø–æ —Å—Å—ã–ª–∫–µ</p>
<pre><code class="hljs language-go"><span class="hljs-keyword">interface</span> Worker {
  run(<span class="hljs-type">bool</span> *done): void
}

class Work implements Worker {
  run(<span class="hljs-type">bool</span> *done) {
    while(!done) { ... }
  }
}
class WaitSignal implements Worker {
  run(<span class="hljs-type">bool</span> *done) {
    <span class="hljs-comment">// wait SIGINT, SIGTERM os signal, see man</span>
    *done = <span class="hljs-literal">true</span>
  }
}

<span class="hljs-comment">// main</span>
atomic <span class="hljs-type">bool</span> done = <span class="hljs-literal">false</span>
Workers works = [<span class="hljs-built_in">new</span> Work, <span class="hljs-built_in">new</span> WaitSignal]
<span class="hljs-keyword">for</span> (work of works) {
  wg.add()
  create_thread(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">// create new thread</span>
    work.run(&#x26;done)
    wg.done()
  })
}
wg.wait()
</code></pre>
<p><code>SIGINT</code>, <code>SIGTERM</code> - —ç—Ç–æ —Å–∏–≥–Ω–∞–ª—ã –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ctrl+c –∏ kill –ø—Ä–æ—Ü–µ—Å—Å–∞, –µ—Å–ª–∏ –º—ã –≥–æ–≤–æ—Ä–∏–º –æ —Å–µ—Ç–µ–≤–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ —ç—Ç–æ –º–∏—Ä unix —Å–∏—Å—Ç–µ–º –∏ –∏—Ö –Ω—É–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å. –¢–æ—Ç –∂–µ docker –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.</p>
<p>–ï—Å–ª–∏ —É –≤–∞—Å –≤ –ø–æ—Ç–æ–∫–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫–æ–µ-—Ç–æ –¥–æ–ª–≥–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–ª–∞–≥ –∏ —Ç—É–¥–∞</p>
<pre><code class="hljs language-go">run(<span class="hljs-type">bool</span> *done) {
  longFunction(done)
}

longFunction(<span class="hljs-type">bool</span> *done) {
  while(!done) { ... } 
}
</code></pre>
<p>–î–æ–ª–≥–∏–º –≤ —Å–µ—Ç–µ–≤–æ–º –º–∏—Ä–µ –º–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ª—é–±–æ–π —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–µ—Ç—å ‚Äî –Ω–µ –∏–¥–µ–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞, –∏ –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –∏–¥—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤/–º–∏–Ω—É—Ç, –≤—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É, –Ω–æ –≤—Å–µ –µ—â–µ –∂–¥–µ—Ç–µ, –ø–æ–∫–∞ –≤ –∫–∞–∫–æ–º-—Ç–æ –ø–æ—Ç–æ–∫–µ –∏–¥–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–æ–¥–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏, —ç—Ç—É —Ç–µ–º—É –º—ã –∑–∞—Ç—Ä–æ–Ω–µ–º –¥–∞–ª–µ–µ.</p>
<h2>–°–ª–æ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤</h2>
<p>–í —è–∑—ã–∫–µ Go –µ—Å—Ç—å –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–∞–∫–µ—Ç –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º <a href="https://pkg.go.dev/context">Context</a> –≤ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —è —Ç–∞–∫–æ–≥–æ –Ω–µ –≤—Å—Ç—Ä–µ—á–∞–ª, –Ω–æ —ç—Ç–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –æ—á–µ–Ω—å —É–¥–æ–±–Ω–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.</p>
<pre><code class="hljs language-go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// Deadline returns the time when work done on behalf of this context</span>
	<span class="hljs-comment">// should be canceled. Deadline returns ok==false when no deadline is</span>
	<span class="hljs-comment">// set. Successive calls to Deadline return the same results.</span>
	Deadline() (deadline time.Time, ok <span class="hljs-type">bool</span>)
	<span class="hljs-comment">// Done returns a channel that's closed when work done on behalf of this</span>
	<span class="hljs-comment">// context should be canceled.</span>
	Done() &#x3C;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}
	Value(key <span class="hljs-keyword">interface</span>{}) <span class="hljs-keyword">interface</span>{}
}
</code></pre>
<p>–º–µ—Ç–æ–¥ Done() ‚Äî —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –∑–Ω–∞–∫–æ–º–æ–µ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –Ω–∞—à —Ñ–ª–∞–≥, —ç—Ç–æ –æ–Ω –∏ –µ—Å—Ç—å, –Ω–æ —Ñ–∏—à–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è —Ç–æ, —á—Ç–æ –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ –∫–æ–ø–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ, –Ω–æ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã, –∏ –µ—Å–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Ä–æ–¥–∏—Ç–µ–ª—å, –æ–Ω —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã, —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º–Ω–æ–≥–æ –≥–∏–±—á–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏.<br>
–í —è–∑—ã–∫–µ Go –ø—Ä–∏–Ω—è—Ç–æ, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ DI –ø–µ—Ä–≤—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º —Ñ—É–Ω–∫—Ü–∏–∏, —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –æ–±—è–∑–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫—Ä—ã—Ç.</p>
<pre><code class="hljs language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">work</span><span class="hljs-params">(ctx context.Context)</span></span> {
  <span class="hljs-keyword">for</span> { <span class="hljs-comment">// endless loop</span>
	<span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &#x3C;-ctx.Done():
			<span class="hljs-keyword">return</span>
		}
	}
}
</code></pre>
<p>–†–∞—Å—Å–º–æ—Ç—Ä–∏ –º–µ—Ç–æ–¥ WithCancel</p>
<pre><code>ctx, cancel := context.WithCancel(context.Background())
</code></pre>
<p>context.Background() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –∏ —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –¢–û–õ–¨–ö–û –æ–¥–∏–Ω —Ä–∞–∑ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º main –ø–æ—Ç–æ–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ cancel() –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–∫—Ä–æ—é—Ç—Å—è = –∑–∞–∫—Ä–æ—é—Ç—Å—è –≤—Å–µ –ø–æ—Ç–æ–∫–∏ –∏ –≤—Å–µ –∏—Ö –¥–æ—á–µ—Ä–Ω–∏–µ –ø–æ—Ç–æ–∫–∏.</p>
<p>—Ç–µ–ø–µ—Ä—å –ø–æ–≥–ª—è–¥–∏–º –∑–∞—á–µ–º –Ω—É–∂–Ω–æ —ç—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</p>
<pre><code class="hljs language-go">mainCtx, cancel := context.WithCancel(context.Background())
<span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// –≤—ã–∑–æ–≤–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">work1</span><span class="hljs-params">(parentCtx context.Context)</span></span> {
  work1Ctx, cancelWork1Ctx := context.WithCancel(parentCtx)
  <span class="hljs-keyword">defer</span> cancelWork1Ctx() <span class="hljs-comment">// defer –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ work1</span>
  <span class="hljs-keyword">go</span> work2(work1Ctx) <span class="hljs-comment">// —Å–æ–∑–¥–∞–ª–∏ –ø–æ—Ç–æ–∫ —Å work2</span>
  <span class="hljs-keyword">for</span> { <span class="hljs-comment">// –¥–µ–ª–∞–µ–º —Ä–∞–±–æ—Ç—É</span>
    <span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &#x3C;-parentCtx.Done(): <span class="hljs-comment">// –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–∫—Ä—ã—Ç –ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</span>
			<span class="hljs-keyword">return</span>
		}
	}
  }
  <span class="hljs-comment">// –∑–∞–≤–µ—Ä—à–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç—É</span>
  <span class="hljs-comment">// –≤—ã–∑—ã–≤–∞—é—Ç—Å—è defer</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">work2</span><span class="hljs-params">(parentCtx context.Context)</span></span> {
  ... –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–∫—Ä—ã—Ç –ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
}

<span class="hljs-keyword">go</span> work1(mainCtx) <span class="hljs-comment">// —Å–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã</span>

<span class="hljs-comment">// –∂–¥–µ–º –Ω–∞–ø—Ä–∏–º–µ—Ä —Å–∏–≥–Ω–∞–ª–∞ sigterm, sigint </span>
done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
signal.Notify(done, os.Interrupt, syscall.SIGINT, syscall.SIGTERM)
 
<span class="hljs-comment">// —ç—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ—ç—Ç–æ–º—É –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç "–≤–∏—Å–µ—Ç—å"</span>
&#x3C;-done
<span class="hljs-comment">// –≤—ã–∑—ã–≤–∞—é—Ç—Å—è defer</span>
</code></pre>
<p>—Å—É—Ç—å —Ç–∞–∫–∞—è, –µ—Å–ª–∏ –º—ã –∑–∞–≤–µ—Ä—à–∏–º work1Ctx - –∑–∞–∫—Ä–æ—é—Ç—Å—è –ª–∏—à—å —Ç–µ –ø–æ—Ç–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—É—à–∞—é—Ç —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø—Ä–∏ —ç—Ç–æ–º –∫—Ç–æ —Å–ª—É—à–∞–µ—Ç mainCtx –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å mainCtx - –æ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç –¥–æ—á–µ—Ä–Ω–∏–π work1Ctx —Ç–µ–º —Å–∞–º—ã–º –ø–æ —Ü–µ–ø–æ—á–∫–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –≤—Å–µ –ø–æ—Ç–æ–∫–∏.</p>
<p>–í—Ç–æ—Ä–∞—è –Ω–µ–º–∞–ª–æ–≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è context.WithTimeout - –æ–Ω–∞ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å ‚Äú–∑–∞–≤–∏—Å—à–∏–µ‚Äú —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, ‚Äú—Å–ª–∏—à–∫–æ–º‚Äú –¥–æ–ª–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–∫—Ä—ã–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω—É–∂–Ω–æ –ü–û–°–õ–ï —Ç–æ–≥–æ –∫–∞–∫ —Å–æ–≤–µ—Ä—à–∏—Ç—å—Å—è –¥–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è, —Ä–∞–Ω—å—à–µ —á–µ–º —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–π–º–µ—Ä.</p>
<pre><code>func slowOperationWithTimeout(ctx context.Context) (Result, error) {
	ctx, cancel := context.WithTimeout(ctx, 100*time.Millisecond)
	defer cancel()  // releases resources if slowOperation completes before timeout elapses
	return slowOperation(ctx)
}
</code></pre>
<p>–ö–∞–∫ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ slowOperation –≤–Ω—É—Ç—Ä–∏ —Ç–∞–∫ –∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ctx.Done() –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –µ—Å–ª–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.</p>
<p>–í–æ–∑–º–æ–∂–Ω–æ –≤ –≤–∞—à–µ–º —è–∑—ã–∫–µ –µ—Å—Ç—å –ø–æ–¥–æ–±–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –∞ –º–æ–∂–µ—Ç –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å context –Ω–∞ —Å–≤–æ–π —è–∑—ã–∫, –±–ª–∞–≥–æ –∫–æ–¥ –ø–∞–∫–µ—Ç–æ–≤ go —ç—Ç–æ open source <a href="https://github.com/golang/go/blob/master/src/context/context.go">https://github.com/golang/go/blob/master/src/context/context.go</a></p>
<h1>–ù–µ–º–Ω–æ–≥–æ –æ –º—å—é—Ç–µ–∫—Å–∞—Ö –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–µ state –º–∞—à–∏–Ω—ã</h1>
<p>–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º/–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–º –∫–æ–¥–æ–º —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ –≤—ã —Å—Ç–æ–ª–∫–Ω–µ—Ç–µ—Å—å —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ–Ω–∫–∏ (race condition)</p>
<pre><code class="hljs language-go"><span class="hljs-type">int</span> x = <span class="hljs-number">0</span>
thread_work1() {
  x = x + <span class="hljs-number">5</span>
}
thread_work2() {
  x = x + <span class="hljs-number">3</span>
}

<span class="hljs-built_in">print</span>(x) <span class="hljs-comment">// ?</span>
</code></pre>
<p>–ø–æ—Ç–æ–∫–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –æ—á–µ—Ä–µ–¥–∏, –æ—á–µ—Ä–µ–¥—å –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ —Å–∞–º–æ–≥–æ —è–∑—ã–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä Go). –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ x –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –Ω–∞ 3, 5 –∏–ª–∏ 8</p>
<p>–í—ã—à–µ —è –ø—Ä–∏–≤–æ–¥–∏–ª –≤ –ø—Ä–∏–º–µ—Ä –∞—Ç–æ–º–∞—Ä–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –ø–æ–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∞–ª–µ–∫–æ –Ω–µ –≤–æ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –∞ —ç—Ç–æ —É–∂–µ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å. –ü–æ—ç—Ç–æ–º—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤ –≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –ø—Ä–∏–¥—É–º–∞–ª–∏ –º—å—é—Ç–µ–∫—Å—ã, —Å–µ–º–∞—Ñ–æ—Ä—ã –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏.</p>
<blockquote>
<p>–ó–∞–¥–∞—á–µ–π –º—å—é—Ç–µ–∫—Å–∞¬†—è–≤–ª—è–µ—Ç—Å—è –∑–∞—â–∏—Ç–∞ –æ–±—ä–µ–∫—Ç–∞ –æ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–º—É –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–æ–∫–æ–≤, –æ—Ç–ª–∏—á–Ω—ã—Ö –æ—Ç —Ç–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–ª–∞–¥–µ–ª –º—å—é—Ç–µ–∫—Å–æ–º. –í –∫–∞–∂–¥—ã–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ—Ç—å –æ–±—ä–µ–∫—Ç–æ–º, –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –º—å—é—Ç–µ–∫—Å–æ–º. –ï—Å–ª–∏ –¥—Ä—É–≥–æ–º—É –ø–æ—Ç–æ–∫—É –±—É–¥–µ—Ç –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º, –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –º—å—é—Ç–µ–∫—Å–æ–º, —Ç–æ —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫¬†<a href="https://ru.wikipedia.org/wiki/%D0%91%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)">–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è</a>¬†–¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –º—å—é—Ç–µ–∫—Å –Ω–µ –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω. –ú—å—é—Ç–µ–∫—Å –∑–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (<a href="https://ru.wikipedia.org/wiki/%D0%A1%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D0%B5_%D0%B3%D0%BE%D0%BD%D0%BA%D0%B8">—Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏</a>), –æ–¥–Ω–∞–∫–æ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–≥—É—Ç –ø–æ—Ä–æ–∂–¥–∞—Ç—å—Å—è –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã,¬†–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†<a href="https://ru.wikipedia.org/wiki/%D0%92%D0%B7%D0%B0%D0%B8%D0%BC%D0%BD%D0%B0%D1%8F_%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0">–≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞</a>¬†–∏–ª–∏ –¥–≤–æ–π–Ω–æ–π –∑–∞—Ö–≤–∞—Ç.</p>
</blockquote>
<p>–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ Go, –æ–Ω –∏–º–µ–µ—Ç –ø–∞–∫–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ sync.Mutex –∫–æ—Ç–æ—Ä—ã–π –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç –Ω–∞—Å –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥ –∫–æ—Ç–æ—Ä—É—é –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞. –û–Ω –∏–º–µ–µ—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ Lock –∏ Unlock</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// SafeCounter is safe to use concurrently.</span>
<span class="hljs-keyword">type</span> SafeCounter <span class="hljs-keyword">struct</span> {
	mu sync.Mutex
	v  <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>
}

<span class="hljs-comment">// Inc increments the counter for the given key.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SafeCounter)</span></span> Inc(key <span class="hljs-type">string</span>) {
	c.mu.Lock()
	<span class="hljs-comment">// Lock so only one goroutine at a time can access the map c.v.</span>
	c.v[key]++
	c.mu.Unlock()
}

<span class="hljs-comment">// Value returns the current value of the counter for the given key.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SafeCounter)</span></span> Value(key <span class="hljs-type">string</span>) <span class="hljs-type">int</span> {
	c.mu.Lock()
	<span class="hljs-comment">// Lock so only one goroutine at a time can access the map c.v.</span>
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	<span class="hljs-keyword">return</span> c.v[key]
}
</code></pre>
<p>–í —Ç–∞–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏ –º—ã –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö –≤—ã–∑—ã–≤–∞–µ–º c.Inc(‚Äúkey‚Äú), –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ c.mu.Lock() - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ ‚Äú–∑–∞–≤–∏—Å–Ω—É—Ç‚Äú –≤ –æ–∂–∏–¥–∞–Ω–∏–∏, —Ç–µ–º —Å–∞–º—ã–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞.</p>
<p>–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ –Ω–µ–ª—å–∑—è –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è - —Ç–µ–º —Å–∞–º—ã–º –≤—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç–µ —Ä–∞–±–æ—Ç—É –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ —Ü–µ–ª–æ–º –∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç–µ –≤—ã–≥–æ–¥—ã –æ—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏.</p>
<p>–ï—Å–ª–∏ –∂–µ –≤—ã –∑–∞–±—É–¥–µ—Ç–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å, –≤–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –±—É–¥—É—Ç ‚Äú–∂–¥–∞—Ç—å‚Äú –µ–≥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —Ç–∞–∫ —á—Ç–æ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã üôÇ</p>
<h2>State machine (–∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç)</h2>
<p>–í—Å–µ –Ω–∞—à–∏ —Å –≤–∞–º–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã —ç—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã, –∏ –∫–∞–∫ –≤—ã –º–æ–≥–ª–∏ –∑–∞–º–µ—Ç–∏—Ç—å –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –ø–æ—Ç–æ–∫–æ–≤ —É –Ω–∞—Å –∫—Ä—É—Ç—è—Ç—Å—è –∫–∞–∫–∏–µ-—Ç–æ ‚Äú–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ‚Äù —Ü–∏–∫–ª—ã.</p>
<p>–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –≤ —Ç–æ–º, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—ë –≤—Ä–µ–º—è —Å–º–µ–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –ù–∞–±–æ—Ä —ç—Ç–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∞ —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –Ω–∏–º–∏, –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏¬†<em>–∫–æ–Ω–µ—á–µ–Ω</em>. –ù–∞—Ö–æ–¥—è—Å—å –≤ —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –ø–æ-—Ä–∞–∑–Ω–æ–º—É —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Å –Ω–µ–π.</p>
<p>–î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑—å–º–µ–º –Ω–∞—à encoder, –æ–Ω —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è, –∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É. –û—Ç–æ–±—Ä–∞–∑–∏–º —ç—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è</p>
<pre><code class="hljs language-go">enum State {
  INIT
  DESTROY
}
</code></pre>
<p>–î–æ–ø—É—Å—Ç–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ HTTP, —Å–æ–∑–¥–∞–¥–∏–º worker —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —Å–µ—Ä–≤–µ—Ä</p>
<pre><code class="hljs language-go">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a ApiServer)</span></span> Start(ctx context.Context, sm: StateMachine) <span class="hljs-type">error</span> {
  s := createServer()
  registerRoutes(sm)
  
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		&#x3C;-ctx.Done()
		<span class="hljs-comment">// timer for close all connections</span>
		timeoutCtx, shutdown := context.WithTimeout(ctx, <span class="hljs-number">5</span>*time.Second)
		_ = s.Shutdown(timeoutCtx)
		shutdown()
	}()
	
	<span class="hljs-keyword">if</span> err := s.Serve(listener); err != http.ErrServerClosed {
		<span class="hljs-keyword">return</span> err
	}
	
	<span class="hljs-comment">//  close database connections here</span>

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">registerRoutes</span><span class="hljs-params">(sm: StateMachine)</span></span> {
 <span class="hljs-comment">// —É–ø—Ä–æ—Å—Ç–∏–º –∫–æ–¥</span>
 handleFunc(<span class="hljs-string">"/api/v1/init"</span>, () { <span class="hljs-keyword">return</span> sm.Set(INIT) })
 handleFunc(<span class="hljs-string">"/api/v1/state"</span>, () { <span class="hljs-keyword">return</span> sm.State() })
 handleFunc(<span class="hljs-string">"/api/v1/destroy"</span>, () { <span class="hljs-keyword">return</span> sm.Set(DESTROY) })	
}
</code></pre>
<p>–î–∞–ª—å—à–µ —Å–¥–µ–ª–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// wokers/encoder.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context, sm: StateMachine)</span></span> <span class="hljs-type">error</span> {
  <span class="hljs-keyword">var</span> destroy context.CancelFunc
  
  <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> destroy != <span class="hljs-literal">nil</span> {
      destroy()
    } 
  }()
  
  <span class="hljs-keyword">for</span> { <span class="hljs-comment">// –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫—Å–ª</span>
    <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> state &#x3C;-sm.State():
          <span class="hljs-keyword">switch</span> state {
            <span class="hljs-keyword">case</span> INIT:
              <span class="hljs-keyword">var</span> encoderCtx context.Context
              encoderCtx, destroy = context.WithCancel(ctx)
              <span class="hljs-keyword">go</span> init(encoderCtx)
          <span class="hljs-keyword">case</span> DESTROY:
              destroy()
          }
        <span class="hljs-keyword">case</span> &#x3C;-ctx.Done(): <span class="hljs-comment">// –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è?</span>
          <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>–¢–µ–ø–µ—Ä—å —Å–æ–±–µ—Ä–µ–º –Ω–∞—à—É –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// main</span>
state := sm.New()
ctx, cancel := context.WithCancel(context.Background())
<span class="hljs-keyword">defer</span> cancel()

<span class="hljs-comment">// –∑–∞–ø—É—Å—Ç–∏–º –ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤</span>
<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
  quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
  signal.Notify(quit, os.Interrupt, syscall.SIGINT, syscall.SIGTERM)
  <span class="hljs-keyword">select</span> {
	<span class="hljs-keyword">case</span> &#x3C;-ctx.Done():
		<span class="hljs-keyword">return</span>
	<span class="hljs-keyword">case</span> &#x3C;-quit:
		cancel()
	}
}

<span class="hljs-keyword">var</span> wg sync.WaitGroup
Workers works = [api.New(), encoder.New()]
wg.Add(<span class="hljs-built_in">len</span>(works))
<span class="hljs-keyword">for</span> _, work := <span class="hljs-keyword">range</span> works {
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">// create new thread</span>
    work.Start(ctx, state)
    wg.Done()
  }()
}
wg.Wait()
</code></pre>
<p>–≠–∫–∑–µ–º–ø–ª—è—Ä state —É –Ω–∞—Å –æ–¥–∏–Ω - –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º –ø–æ—Ç–æ–∫–∞–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, –¥—Ä—É–≥–æ–π —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–µ.</p>
<p>–ü–æ —Ñ–∞–∫—Ç—É —É –Ω–∞—Å –ø–æ–ª—É—á–∏–ª–æ—Å—å 6 –ø–æ—Ç–æ–∫–æ–≤ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏</p>
<ol>
<li>
<p>–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–∂–∏–¥–∞—é—â–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤</p>
<ol>
<li>
<p>–ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã</p>
</li>
<li>
<p>–ø–æ—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ http</p>
<ol>
<li>–ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞—é—â–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è http —Å–µ—Ä–≤–µ—Ä–∞</li>
</ol>
</li>
<li>
<p>–ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–µ–π—Ç –º–∞—à–∏–Ω—ã</p>
<ol>
<li>–ø–æ—Ç–æ–∫ –µ–Ω–∫–æ–¥–µ—Ä–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Å—Ç–µ–π—Ç –º–∞—à–∏–Ω–æ–π</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1>–°–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã</h1>
<h2>–ü—Ä–æ—Ü–µ—Å—Å—ã, –ø–æ—Ç–æ–∫–∏, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h2>
<ul>
<li>–¢–∞–Ω–µ–Ω–±–∞—É–º –≠.–°. "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã"</li>
<li>–†–∏—Ö—Ç–µ—Ä –î–∂–µ—Ñ—Ñ—Ä–∏ ‚ÄúWindows –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤. –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö Win32-–øp–∏–ªo–∂e–Ω–∏–π —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ 64-—Ä–∞–∑—Ä—è–¥–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Windows‚Äù</li>
</ul>
<h2>–ü–∞—Ç—Ç–µ—Ä–Ω—ã</h2>
<p><a href="https://refactoring.guru/ru/design-patterns/state">https://refactoring.guru/ru/design-patterns/state</a>
<a href="https://go.dev/blog/pipelines">https://go.dev/blog/pipelines</a></p>
<h2>WaitGroup</h2>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects?redirectedfrom=MSDN">WaitForMultipleObjects function (synchapi.h)</a><br>
<a href="https://stackoverflow.com/questions/2719580/waitforsingleobject-and-waitformultipleobjects-equivalent-in-linux">WaitForSingleObject and WaitForMultipleObjects equivalent in Linux?</a><br>
<a href="https://www.boost.org/doc/libs/1_34_0/doc/html/boost/thread_group.html">Boost class thread_group</a></p></div></article><div class="post-tags"><div class="topics-list"><div class="topic-item"><a class="topic-item-link" rel="noopener follow" href="/tag/architecture.html"><div class="topic-item-text">Architecture</div></a></div><div class="topic-item"><a class="topic-item-link" rel="noopener follow" href="/tag/golang.html"><div class="topic-item-text">Golang</div></a></div></div></div></div></main><footer class="article-footer"><div class="container"><div class="content"><div class="space"></div><section class="author-section"><a class="author-section-left" rel="noopener follow" href="/"><div class="avatar-box"><img class="avatar mobile-hide" alt="Igor Riakhovskii" src="/v1/resize:fill:96:96/public/avatar.jpg" width="48" height="48" loading="lazy"><div class="avatar-shadow mobile-hide"></div><img class="avatar-big mobile-only" alt="Igor Riakhovskii" src="/v1/resize:fill:128:128/public/avatar.jpg" width="64" height="64" loading="lazy"><div class="avatar-big-shadow mobile-only"></div></div></a><div><a class="author-name" rel="noopener follow" href="/">Written by Igor Riakhovskii</a><div class="author-summary">In commercial development since 2005. At the moment, I am engaged in product development of cloud systems in the role of Technical Lead</div></div></section></div></div></footer></body></html>